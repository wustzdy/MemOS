import json
import os
import sys
from typing import Optional

src_path = os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "..", "src"))
sys.path.insert(0, src_path)

import psycopg2

from memos.configs.graph_db import GraphDBConfigFactory
from memos.graph_dbs.factory import GraphStoreFactory


def getPolarDb():
    config = GraphDBConfigFactory(
        backend="polardb",
        config={
            "host": os.getenv("POLAR_DB_HOST", "xxxxx"),
            "port": int(os.getenv("POLAR_DB_PORT", "5432")),
            "user": os.getenv("POLAR_DB_USER", "xxxxx"),
            "password": os.getenv("POLAR_DB_PASSWORD", "xxx"),
            "db_name": os.getenv("POLAR_DB_DB_NAME", "xxx"),
            "user_name": os.getenv("POLARDB_USER_NAME", "xxx"),
            "use_multi_db": os.getenv("POLARDB_USE_MULTI_DB", "True").lower() == "true",  # 设置为True，不添加user_name过滤条件
            "auto_create": True,
            "embedding_dimension": 1024,
        },
    )
    graph = GraphStoreFactory.from_config(config)
    return graph


def test_search_by_embedding(graph, vector: list[float], user_name: Optional[str] = None,
                             filter: Optional[dict] = None,knowledgebase_ids: Optional[list[str]] = None):
    """Test search_by_embedding function."""
    # Query search_by_embedding
    nodes = graph.search_by_embedding(
        vector=vector, top_k=100, user_name=user_name, filter=filter,knowledgebase_ids=knowledgebase_ids
    )
    print(f"test_search_by_embedding: nodes count: {len(nodes)}")
    for node_i in nodes:
        print(f"Search result id: {node_i['id']}, score: {node_i.get('score', 'N/A')}")


def test_get_node(graph, node_id: str, user_name: Optional[str] = None):
    """Test get_node function - query single node."""
    detail = graph.get_node(id=node_id, user_name=user_name)
    print(f"test_get_node: {detail}")


def test_get_nodes(graph, ids: list[str], user_name: Optional[str] = None):
    """Test get_nodes function - query multiple nodes."""
    detail_list = graph.get_nodes(ids=ids, user_name=user_name)
    print(f"test_get_nodes: count: {len(detail_list)}")
    print(f"test_get_nodes: {detail_list}")


def test_update_node(graph, node_id: str, fields: dict, user_name: Optional[str] = None):
    """Test update_node function."""
    result = graph.update_node(id=node_id, fields=fields, user_name=user_name)
    print(f"test_update_node: {result}")


def test_get_memory_count(graph, scope: str, user_name: Optional[str] = None):
    """Test get_memory_count function."""
    count = graph.get_memory_count(scope, user_name)
    print(f"test_get_memory_count: {count}")


def test_node_not_exist(graph, scope: str, user_name: Optional[str] = None):
    """Test node_not_exist function - check if node exists."""
    isNodeExist = graph.node_not_exist(scope, user_name)
    print(f"test_node_not_exist: {isNodeExist}")


def test_remove_oldest_memory(graph, scope: str, skip_count: int, user_name: Optional[str] = None):
    """Test remove_oldest_memory function - remove oldest memory after skipping."""
    result = graph.remove_oldest_memory(scope, skip_count, user_name)
    print(f"test_remove_oldest_memory: {result}")


def test_delete_node(graph, node_id: str, user_name: Optional[str] = None):
    """Test delete_node function."""
    isNodeDeleted = graph.delete_node(id=node_id, user_name=user_name)
    print(f"test_delete_node: {isNodeDeleted}")
    # detail_list = graph.get_nodes(ids=ids,user_name='memos7a9f9fbbb61c412f94f77fbaa8103c35')
    # print("1111多个node:", len(detail_list))
    # #
    # print("多个node:", detail_list)

    # 4，更新 update_node
    # graph.update_node(id="000009999ef-926f-42e2-b7b5-0224daf0abcd", fields={"name": "new_name"})

    # 4，查询 get_memory_count
    # count = graph.get_memory_count('UserMemory','memos07ba3d044650474c839e721f3a69d38a')
    # print("user count:", count)
    # #
    # # 4，判断node是否存在 node_not_exist 1代表存在，
    # isNodeExist = graph.node_not_exist('UserMemory', 'memos07ba3d044650474c839e721f3a69d38a')
    # print("user isNodeExist:", isNodeExist)
    #
    # # 6,删除跳过多少行之后的数据remove_oldest_memory
    # remove_oldest_memory = graph.remove_oldest_memory('UserMemory', 2,'memos07ba3d044650474c839e721f3a69d38a')
    # print("user remove_oldest_memory:", remove_oldest_memory)

    # 7，更新 update_node
    # isNodeExist = graph.update_node(id="bb079c5b-1937-4125-a9e5-55d4abe6c95d", fields={"status": "inactived","tags": ["yoga", "travel11111111", "local studios5667888"]})
    # print("user update_node:", isNodeExist)

    # 8，删除 delete_node
    # isNodeDeleted = graph.delete_node(id="bb079c5b-1937-4125-a9e5-55d4abe6c95d", user_name='memosbfb3fb32032b4077a641404dc48739cd')
    # print("user isNodeDeleted:", isNodeDeleted)


# 9，添加边 add_edge
def add_edge(
        db_name: str, source_id: str, target_id: str, edge_type: str = "Memory", user_name: Optional[str] = None
):
    graph = getPolarDb(db_name)
    graph.add_edge(source_id, target_id, edge_type, user_name)


def edge_exists(
        db_name: str,
        source_id: str,
        target_id: str,
        type: str = "Memory",
        direction: str = "OUTGOING",
        user_name: Optional[str] = None,
):
    graph = getPolarDb(db_name)
    isEdge_exists = graph.edge_exists(
        source_id=source_id,
        target_id=target_id,
        type=type,
        user_name=user_name,
        direction=direction,
    )
    print("edge_exists:", isEdge_exists)


def get_children_with_embeddings(db_name: str, id: str, user_name: Optional[str] = None):
    graph = getPolarDb(db_name)
    children = graph.get_children_with_embeddings(id=id, user_name=user_name)
    print("get_children_with_embedding:", children)


def get_subgraph(db_name, center_id, depth, center_status, user_name):
    graph = getPolarDb(db_name)
    subgraph = graph.get_subgraph(center_id, depth, center_status, user_name)
    print("111111get_subgraph:", subgraph)
    # subgraph = convert_graph_edges(subgraph)
    # print("222222get_subgraph:", subgraph)


def convert_graph_edges(core_node: dict) -> dict:
    import copy

    data = copy.deepcopy(core_node)

    id_map = {}

    core_node = data.get("core_node", {})
    core_meta = core_node.get("metadata", {})
    if "graph_id" in core_meta and "id" in core_node:
        id_map[core_meta["graph_id"]] = core_node["id"]

    for neighbor in data.get("neighbors", []):
        n_meta = neighbor.get("metadata", {})
        if "graph_id" in n_meta and "id" in neighbor:
            id_map[n_meta["graph_id"]] = neighbor["id"]

    for edge in data.get("edges", []):
        src = edge.get("source")
        tgt = edge.get("target")

        if src in id_map:
            edge["source"] = id_map[src]
        if tgt in id_map:
            edge["target"] = id_map[tgt]

    return data


def get_grouped_counts(db_name, user_name):
    graph = getPolarDb(db_name)
    grouped_counts = graph.get_grouped_counts(
        group_fields=["status"],
        where_clause="user_name = %s",
        params=[user_name],
        user_name=user_name,
    )
    grouped_counts = graph.get_grouped_counts1(
        group_fields=["status"], params=[user_name], user_name=user_name
    )
    print("get_grouped_counts:", grouped_counts)


def export_graph(db_name, include_embedding, user_name):
    graph = getPolarDb(db_name)
    export_graphlist = graph.export_graph(include_embedding=include_embedding, user_name=user_name)
    print("export_graph:", export_graphlist)


def get_structure_optimization_candidates(db_name, scope, include_embedding, user_name):
    graph = getPolarDb(db_name)
    candidates = graph.get_structure_optimization_candidates(
        scope=scope, include_embedding=include_embedding, user_name=user_name
    )
    print("get_structure_optimization_candidates:", candidates)


def test_get_all_memory_items(graph, scope: str, include_embedding: bool, user_name: str,
                              filter: Optional[dict] = None,knowledgebase_ids: Optional[list] = None):
    """Test get_all_memory_items function."""
    memory_items = graph.get_all_memory_items(
        scope=scope, include_embedding=include_embedding, user_name=user_name, filter=filter,knowledgebase_ids=knowledgebase_ids
    )
    print(f"test_get_all_memory_items: count: {len(memory_items)}")
    print(f"test_get_all_memory_items: {memory_items}")


def get_neighbors_by_tag(db_name, user_name):
    graph = getPolarDb(db_name)
    tags = ["旅游建议", "景点"]
    ids = ["39d12b46-ebe4-4f25-b0b7-1582042049e7"]
    neighbors = graph.get_neighbors_by_tag(tags=tags, exclude_ids=ids, user_name=user_name)
    print("get_neighbors_by_tag:", neighbors)


def get_edges(db_name: str, id: str, type: str, direction: str, user_name: Optional[str] = None) -> None:
    graph = getPolarDb(db_name)
    edges = graph.get_edges(id=id, type=type, direction=direction, user_name=user_name)
    print("get_edges:", edges)


def test_get_by_metadata(graph, filters: list[dict], user_name: str, filter: Optional[dict] = None,knowledgebase_ids: Optional[list] = None):
    """Test get_by_metadata function."""
    ids = graph.get_by_metadata(filters=filters, user_name=user_name, filter=filter,knowledgebase_ids=knowledgebase_ids)
    print(f"test_get_by_metadata: count: {len(ids)}")
    print(f"test_get_by_metadata: {ids}")


if __name__ == "__main__":
    # Example vector for testing
    vector = [
        -0.059882111847400665,
        0.020448941737413406,
        -0.005792281590402126,
        0.016083329916000366,
        -0.0009665691759437323,
        0.0016216486692428589,
        -0.02259845845401287,
        -0.0012792478082701564,
        0.016644487157464027,
        -0.0013910036068409681,
        -0.02008751966059208,
        0.02077232114970684,
        -0.004075521603226662,
        0.009449313394725323,
        0.0073425970040261745,
        0.0008845356060191989,
        -0.015417550690472126,
        0.02891385369002819,
        0.008688422851264477,
        -0.029541587457060814,
        -0.023283259943127632,
        -0.01937418431043625,
        0.027772516012191772,
        0.038520101457834244,
        -0.005992015358060598,
        0.02250334806740284,
        -0.002231550170108676,
        -0.036693960428237915,
        0.0021970723755657673,
        -0.03507706895470619,
        -0.013239501044154167,
        0.006386727560311556,
        0.013315590098500252,
        -0.07342597097158432,
        -0.0537949837744236,
        -0.059691887348890305,
        0.047441545873880386,
        0.009701358154416084,
        -0.056229833513498306,
        -0.009767936542630196,
        0.00476032355800271,
        -0.008112998679280281,
        0.01600724086165428,
        -0.013382168486714363,
        -0.007323574740439653,
        -0.02758229337632656,
        0.01832795888185501,
        -0.03498195856809616,
        -0.0313296802341938,
        0.007746819872409105,
        0.02704966999590397,
        -0.002993630012497306,
        0.0651703029870987,
        -0.014723238535225391,
        -0.004736545495688915,
        0.039414145052433014,
        -0.006144193932414055,
        0.022313125431537628,
        -0.09518744796514511,
        -0.015360483899712563,
        0.0004009538097307086,
        0.011955497786402702,
        -0.04432189464569092,
        0.029446477070450783,
        0.02023969776928425,
        0.04165877401828766,
        -0.019269561395049095,
        0.015740929171442986,
        0.012840033508837223,
        0.008365044370293617,
        -0.022541392594575882,
        -0.001721515553072095,
        -0.03224274888634682,
        -0.027658382430672646,
        -0.04869701340794563,
        0.004998101852834225,
        -0.012602254748344421,
        -0.012098164297640324,
        -0.02200876735150814,
        0.038063567131757736,
        0.00469612330198288,
        -0.0022220390383154154,
        0.016948843374848366,
        0.024443618953227997,
        0.03749289736151695,
        0.02476699836552143,
        0.005730459466576576,
        0.0463762991130352,
        -0.013039766810834408,
        -0.006881306879222393,
        0.024158284068107605,
        -0.02368272840976715,
        0.0592353530228138,
        -0.004348966758698225,
        -0.030340522527694702,
        -0.008445888757705688,
        -0.01779533550143242,
        0.059844065457582474,
        0.02216094732284546,
        0.00398516608402133,
        -0.004917256999760866,
        0.0503329299390316,
        -0.02541375532746315,
        -0.010871227830648422,
        0.07327379286289215,
        -0.012155231088399887,
        0.03235688433051109,
        -0.003397853346541524,
        -0.01643524318933487,
        -0.011907941661775112,
        0.050066620111465454,
        0.015037105418741703,
        0.0090688681229949,
        0.014970527961850166,
        5.1791106670862064e-05,
        -0.008455399423837662,
        -0.028894830495119095,
        -0.01949782855808735,
        0.043256644159555435,
        -0.018841560930013657,
        0.018870092928409576,
        0.029541587457060814,
        0.054898276925086975,
        -0.025832245126366615,
        -0.014780305325984955,
        -0.034715645015239716,
        -0.008617089129984379,
        -0.01845160312950611,
        -0.007333085872232914,
        -0.016102353110909462,
        0.03351724147796631,
        -0.015712397173047066,
        -0.01928858272731304,
        0.01671106554567814,
        -0.007994109764695168,
        -0.03566676005721092,
        0.002178050111979246,
        -0.03346017748117447,
        -0.004945790395140648,
        -0.05619179084897041,
        0.027696426957845688,
        -0.0020246829371899366,
        -0.03891956806182861,
        -0.01835649274289608,
        0.011061450466513634,
        -0.04706110060214996,
        0.03237590566277504,
        -0.04219139739871025,
        -0.0155411958694458,
        -0.0024776507634669542,
        -0.030663901939988136,
        0.00886913388967514,
        0.009254335425794125,
        0.011042428202927113,
        -0.006947884801775217,
        -0.00797033216804266,
        -0.05642005801200867,
        0.05584938824176788,
        -0.015341461636126041,
        -0.007242729887366295,
        -0.0037925653159618378,
        -0.021704411134123802,
        -0.06631163507699966,
        -0.013981369324028492,
        0.02767740562558174,
        0.020049475133419037,
        0.041430506855249405,
        -0.020220674574375153,
        -0.02023969776928425,
        -0.005892148707062006,
        0.0009047468192875385,
        -0.006167971529066563,
        -0.0029484520200639963,
        0.018004579469561577,
        0.005901659838855267,
        0.01532243937253952,
        0.023112060502171516,
        0.027125759050250053,
        0.023606639355421066,
        -0.03311777487397194,
        0.012973189353942871,
        0.045729540288448334,
        -0.0010604916606098413,
        -0.04694696515798569,
        -0.019031783565878868,
        0.03357430920004845,
        0.03283243998885155,
        -0.01399088092148304,
        0.0002401561796432361,
        0.009121179580688477,
        0.019516849890351295,
        -0.025299621745944023,
        0.06011037901043892,
        0.012973189353942871,
        0.029731810092926025,
        -0.0075898864306509495,
        0.007390152662992477,
        0.017871424555778503,
        0.005259658209979534,
        -0.012725899927318096,
        0.022788681089878082,
        0.029826922342181206,
        -0.0018106824718415737,
        -0.061860427260398865,
        -0.04816439002752304,
        0.022370191290974617,
        -0.011822341941297054,
        -0.032984618097543716,
        -0.0070049515925347805,
        -0.007998865097761154,
        0.003961388021707535,
        -0.009140201844274998,
        0.03869130089879036,
        -0.006125171668827534,
        -0.05200688913464546,
        0.011489451862871647,
        -0.0320715494453907,
        0.020962543785572052,
        -0.03732169792056084,
        -0.04584367573261261,
        0.005682903807610273,
        0.03216665983200073,
        -0.01993534155189991,
        0.026364868506789207,
        0.02550886571407318,
        -0.007304552476853132,
        0.050256840884685516,
        0.03346017748117447,
        0.03625645115971565,
        0.011508474126458168,
        -0.026821402832865715,
        -0.0231881495565176,
        0.002248194767162204,
        0.0024847842287272215,
        0.032889507710933685,
        -0.014475949108600616,
        -0.017966534942388535,
        0.027468159794807434,
        0.0333079993724823,
        -0.017947513610124588,
        0.019707072526216507,
        -0.039604369550943375,
        0.017405377700924873,
        0.02067720890045166,
        -0.02176147885620594,
        0.029180165380239487,
        -0.03418302163481712,
        0.022541392594575882,
        -0.002004471840336919,
        -0.02522353269159794,
        -0.00015485317271668464,
        -0.012278876267373562,
        -0.04980030655860901,
        0.02600344456732273,
        0.028989942744374275,
        0.028343183919787407,
        0.015855062752962112,
        0.007304552476853132,
        -0.01764315739274025,
        -0.030854124575853348,
        -0.014009903185069561,
        0.023949040099978447,
        0.0323188379406929,
        0.011537007987499237,
        0.01120411790907383,
        0.014447415247559547,
        -0.02912309765815735,
        -0.016368664801120758,
        0.0034026089124381542,
        0.02389197237789631,
        -0.005606814753264189,
        -0.030283456668257713,
        -0.02655509114265442,
        0.008740733377635479,
        -0.02240823581814766,
        0.025794200599193573,
        0.010909272357821465,
        -0.048430703580379486,
        0.05413738638162613,
        -0.011670163832604885,
        0.032737329602241516,
        -0.010766605846583843,
        0.026859447360038757,
        -0.0567624568939209,
        -0.00688606221228838,
        -0.022141924127936363,
        -0.023112060502171516,
        -0.04862092435359955,
        -0.024500686675310135,
        -0.03212861716747284,
        -0.030911190435290337,
        0.015893107280135155,
        0.06482790410518646,
        -0.011166073381900787,
        -0.022427259013056755,
        0.03591404855251312,
        0.004601011984050274,
        -0.16556985676288605,
        0.06600727885961533,
        -0.05915926396846771,
        0.0710291638970375,
        -0.001765504595823586,
        -0.020467964932322502,
        -0.03855814412236214,
        0.03020736761391163,
        -0.10507902503013611,
        -0.002777251647785306,
        -0.06399092078208923,
        -0.06604532897472382,
        0.009591980837285519,
        -0.035267289727926254,
        0.018366003409028053,
        -0.01154651865363121,
        -0.05193080008029938,
        -0.002610806841403246,
        -0.00699544046074152,
        -0.04432189464569092,
        0.012164742685854435,
        -0.004082655068486929,
        0.04747958853840828,
        -0.014390348456799984,
        0.014371326193213463,
        -0.02206583507359028,
        0.02027774229645729,
        -0.013895769603550434,
        -0.05501240864396095,
        0.016720576211810112,
        0.020467964932322502,
        0.004032721742987633,
        -0.0055640144273638725,
        0.030778035521507263,
        0.013163411989808083,
        0.013210967183113098,
        0.010329093784093857,
        -0.03452542424201965,
        0.05851250886917114,
        -0.019202983006834984,
        0.046262163668870926,
        -0.0003462648019194603,
        -0.00251093995757401,
        0.06459963321685791,
        -0.011042428202927113,
        -0.011470429599285126,
        -0.03937610238790512,
        0.019726095721125603,
        -0.0448925606906414,
        -0.034468356519937515,
        0.015503151342272758,
        0.011498963460326195,
        0.018432581797242165,
        -0.03494391217827797,
        -0.028248073533177376,
        0.021438099443912506,
        -0.014447415247559547,
        0.08605675399303436,
        -0.03385964408516884,
        -0.0010355248814448714,
        -0.015484129078686237,
        -0.02324521541595459,
        -0.01310634519904852,
        -0.06357242912054062,
        -0.013020744547247887,
        0.026916515082120895,
        0.06482790410518646,
        0.018774982541799545,
        0.04120223969221115,
        -0.016549376770853996,
        0.03458248823881149,
        0.010795138776302338,
        -0.00013642535486724228,
        -0.025699088349938393,
        0.016368664801120758,
        0.03089216910302639,
        -0.013410701416432858,
        -0.01535097323358059,
        -0.01433328166604042,
        -0.10629645735025406,
        -0.001113991835154593,
        -0.019088849425315857,
        -0.0310823917388916,
        0.009054601192474365,
        0.0021518943831324577,
        -0.03433519974350929,
        0.032889507710933685,
        0.011232651770114899,
        0.05881686508655548,
        0.23952844738960266,
        -0.02181854471564293,
        -0.0062155271880328655,
        0.018527692183852196,
        0.07772500067949295,
        -0.020715253427624702,
        -0.01109949592500925,
        0.024938197806477547,
        -0.04953399673104286,
        -0.05208297818899155,
        -0.000630707188975066,
        0.011242162436246872,
        0.0049125016666948795,
        -0.015417550690472126,
        0.03119652532041073,
        0.02897091954946518,
        -0.006030059885233641,
        -0.020049475133419037,
        0.06631163507699966,
        -0.011984030716121197,
        0.02581322193145752,
        0.004453589208424091,
        0.02718282677233219,
        -0.0013898147735744715,
        -0.017557555809617043,
        -0.05619179084897041,
        -0.03203350678086281,
        0.03444933518767357,
        -0.019611962139606476,
        0.02668824791908264,
        -0.025432776659727097,
        0.029788877815008163,
        0.04679478704929352,
        -0.03226177394390106,
        0.008041664958000183,
        0.02940843254327774,
        0.013743591494858265,
        -0.009805981069803238,
        0.0370173417031765,
        -0.020353831350803375,
        -0.001188891939818859,
        -0.02185658924281597,
        -0.047403499484062195,
        -0.015389017760753632,
        -0.007494775112718344,
        -0.030435634776949883,
        -0.002577517880126834,
        -0.029864966869354248,
        0.01426670327782631,
        -0.011137540452182293,
        -0.029370388016104698,
        -0.04846874624490738,
        -0.051892757415771484,
        -0.016368664801120758,
        -0.00015381289995275438,
        -0.010623938404023647,
        -0.001973560778424144,
        -0.005896904040127993,
        -0.017662178725004196,
        0.011109006591141224,
        -0.006415260955691338,
        0.0057019260711967945,
        0.0018998493906110525,
        0.0439034029841423,
        0.0027748739812523127,
        -0.016045285388827324,
        -0.057561393827199936,
        -0.02556593343615532,
        -0.0005890959873795509,
        0.04253380000591278,
        0.04595780745148659,
        -0.01416208129376173,
        -0.02550886571407318,
        -0.03197643905878067,
        0.021742455661296844,
        0.018993739038705826,
        0.00880731176584959,
        0.0036427651066333055,
        -0.02640291303396225,
        -0.01055736094713211,
        -0.010471760295331478,
        -0.05630592256784439,
        -0.03384062275290489,
        -0.03250906243920326,
        -0.021628322079777718,
        -0.048773106187582016,
        -0.014143059030175209,
        0.02086743153631687,
        -0.024843087419867516,
        -0.022427259013056755,
        -0.00131134781986475,
        -0.008617089129984379,
        -0.039414145052433014,
        -0.0018832049099728465,
        0.01989729516208172,
        0.008160554803907871,
        0.01120411790907383,
        -0.023378372192382812,
        -0.03064487874507904,
        -0.023283259943127632,
        -0.025337666273117065,
        -0.023968061432242393,
        0.009634780697524548,
        -0.017909469082951546,
        -0.027430115267634392,
        -0.007532819639891386,
        0.037283651530742645,
        0.024595797061920166,
        -0.002140005584806204,
        0.020011430606245995,
        0.025680067017674446,
        0.03401182219386101,
        -0.02748718298971653,
        -0.06421919167041779,
        0.0003358619869686663,
        0.017690712586045265,
        0.019022271037101746,
        0.038710322231054306,
        0.0006794517394155264,
        -0.015769463032484055,
        -0.00897851213812828,
        0.05345258489251137,
        0.006990684662014246,
        0.016692044213414192,
        -0.005207346752285957,
        -0.016149908304214478,
        -0.062202829867601395,
        0.017129555344581604,
        0.00843637716025114,
        0.01953587308526039,
        0.034430310130119324,
        -0.024938197806477547,
        0.0394902341067791,
        0.027905672788619995,
        -0.027658382430672646,
        0.02147614397108555,
        0.042419664561748505,
        0.023663705214858055,
        0.018813027068972588,
        -0.006771928630769253,
        -0.02526157721877098,
        -0.009882070124149323,
        -0.003887676866725087,
        -0.0041230772621929646,
        -0.0037545207887887955,
        0.016986887902021408,
        0.016787154600024223,
        -0.05611570179462433,
        -0.008231887593865395,
        0.0006657795165665448,
        0.006125171668827534,
        0.014409370720386505,
        0.036294493824243546,
        -0.02940843254327774,
        -0.005644859280437231,
        -0.037873342633247375,
        -0.04363708943128586,
        0.013724569231271744,
        0.022237036377191544,
        -0.00886913388967514,
        0.002277916995808482,
        -0.007718286477029324,
        0.0483546145260334,
        0.03642765060067177,
        0.029446477070450783,
        0.02157125622034073,
        -0.030682923272252083,
        0.04017503932118416,
        -0.049762263894081116,
        -0.03696027398109436,
        -0.01569337397813797,
        -0.0009647858096286654,
        -0.06429527699947357,
        0.04820243641734123,
        0.009863047860562801,
        -0.05828424170613289,
        -0.01532243937253952,
        -0.03357430920004845,
        -0.01928858272731304,
        -0.04949595034122467,
        0.04455016180872917,
        -0.0429522879421711,
        -0.01453301589936018,
        -0.030416611582040787,
        -0.006729128770530224,
        -0.013182434253394604,
        -0.009534914046525955,
        -0.004722279030829668,
        0.043446868658065796,
        0.002644095802679658,
        -0.035799916833639145,
        0.0922960638999939,
        0.04002286121249199,
        -0.0043632336892187595,
        0.0031196526251733303,
        0.016787154600024223,
        0.01658742129802704,
        -0.01647328771650791,
        -0.00502187991514802,
        -0.03823476657271385,
        0.05744725838303566,
        -0.004422678146511316,
        -0.01169869676232338,
        -0.025737132877111435,
        -0.058055974543094635,
        0.020905476063489914,
        -0.033441152423620224,
        -0.004969568457454443,
        -0.021590277552604675,
        0.03292755037546158,
        -0.01680617779493332,
        -0.0125832324847579,
        -0.0072760190814733505,
        0.018641825765371323,
        0.05063728615641594,
        0.02817198447883129,
        0.04413167014718056,
        0.011679674498736858,
        -0.0021804277785122395,
        -0.03673200681805611,
        0.011318251490592957,
        0.001906982739455998,
        -0.014295237138867378,
        -0.015988219529390335,
        -0.03307972848415375,
        -0.009135445579886436,
        0.04531105235219002,
        -0.022674547508358955,
        0.05432760715484619,
        3.115268555120565e-05,
        -0.003024541074410081,
        -0.01108047366142273,
        -0.004106432665139437,
        0.03247101604938507,
        0.04082179442048073,
        0.014323770068585873,
        0.0038710322696715593,
        0.02550886571407318,
        -0.0038686543703079224,
        -0.014447415247559547,
        0.009687092155218124,
        0.03315581753849983,
        -0.005911170970648527,
        0.07148569822311401,
        -0.00028637435752898455,
        -0.012269365601241589,
        -0.02931332029402256,
        -0.015331950969994068,
        -1.7991278582485393e-05,
        -0.008065443485975266,
        0.01872742548584938,
        -0.023815883323550224,
        -0.011498963460326195,
        0.02117178775370121,
        -0.0006960962782613933,
        0.018242359161376953,
        -0.001524159568361938,
        -0.046604566276073456,
        -0.0328134186565876,
        0.02033480815589428,
        0.018299425020813942,
        -0.005150279961526394,
        0.007380641531199217,
        0.02012556418776512,
        -0.028742652386426926,
        -0.015341461636126041,
        0.03266124054789543,
        -0.05482218787074089,
        0.014295237138867378,
        -0.05664832517504692,
        -0.01643524318933487,
        0.009482602588832378,
        0.0019771272782236338,
        0.03791138902306557,
        0.056572236120700836,
        -0.0029080298263579607,
        -0.02368272840976715,
        -0.0003055452252738178,
        0.0863611102104187,
        -0.004413167014718056,
        -0.014761283062398434,
        0.0493437722325325,
        0.018841560930013657,
        0.014190614223480225,
        0.029237231239676476,
        0.0572570376098156,
        0.012564210221171379,
        -0.0037259873934090137,
        0.024595797061920166,
        -0.04181095212697983,
        -0.0030150299426168203,
        -0.01869889348745346,
        -0.07167591899633408,
        0.0409739725291729,
        -0.008084465749561787,
        -0.030816080048680305,
        -0.017224667593836784,
        0.04702305421233177,
        -0.017043955624103546,
        0.012202787213027477,
        -0.03739778697490692,
        0.009596736170351505,
        -0.032699283212423325,
        0.021438099443912506,
        -0.018622804433107376,
        0.04717523232102394,
        0.004902990534901619,
        -0.01853720284998417,
        0.047593723982572556,
        0.016482798382639885,
        0.028362207114696503,
        -0.005549747962504625,
        0.013391679152846336,
        0.037283651530742645,
        0.009967670775949955,
        0.017976047471165657,
        0.05349062755703926,
        -0.00947309099137783,
        0.003649898339062929,
        0.0004675317613873631,
        -0.0004363233456388116,
        -0.002777251647785306,
        -0.007746819872409105,
        0.009901092387735844,
        -0.005078946705907583,
        0.040935929864645004,
        -0.027449138462543488,
        0.005668636877089739,
        -0.056686367839574814,
        -0.00508370203897357,
        -0.04881114885210991,
        0.011327763088047504,
        -0.001153225195594132,
        0.03557164967060089,
        0.05311018228530884,
        0.006182238459587097,
        0.007494775112718344,
        -0.03384062275290489,
        0.05128404498100281,
        -0.03401182219386101,
        0.04580562934279442,
        0.0016620709793642163,
        0.05383303016424179,
        -0.020848410204052925,
        0.033441152423620224,
        -0.027315981686115265,
        -0.008365044370293617,
        0.011584563180804253,
        -0.00037687874282710254,
        -0.004391767084598541,
        0.004857812542468309,
        0.015702884644269943,
        -0.03463955596089363,
        -0.04036526009440422,
        0.014342792332172394,
        -0.014437904581427574,
        -0.03218568488955498,
        0.029142120853066444,
        0.002655984601005912,
        -0.021000588312745094,
        -0.03705538436770439,
        0.04926768317818642,
        -0.03151990473270416,
        -0.054898276925086975,
        -0.04447407275438309,
        0.006163216196000576,
        0.04949595034122467,
        0.017747780308127403,
        -0.012963677756488323,
        0.0014742260100319982,
        -0.03441128879785538,
        0.02571811154484749,
        -0.0050932131707668304,
        0.0014932482736185193,
        -0.01984022930264473,
        0.03212861716747284,
        -0.024101218208670616,
        -0.016730088740587234,
        0.040098950266838074,
        -0.022636502981185913,
        -0.0009725136333145201,
        0.0023742173798382282,
        -0.055392853915691376,
        -0.03153892606496811,
        0.04120223969221115,
        -0.023758817464113235,
        -0.04124028608202934,
        -0.04101201891899109,
        0.0572570376098156,
        0.02645997889339924,
        -0.022046811878681183,
        -0.01946929469704628,
        -0.027468159794807434,
        -0.024747975170612335,
        -0.15811312198638916,
        0.01742440089583397,
        0.0007923964876681566,
        -0.005678148008882999,
        -0.033327020704746246,
        -0.012373987585306168,
        -0.026669224724173546,
        0.008678911253809929,
        -0.005487925373017788,
        -0.06874649226665497,
        -0.037873342633247375,
        0.036446671932935715,
        0.05265364795923233,
        -0.013981369324028492,
        -0.05349062755703926,
        0.06380070000886917,
        -0.012012564577162266,
        0.03707440569996834,
        0.02402512915432453,
        0.04782199114561081,
        -0.007081040646880865,
        0.00388529896736145,
        0.055050455033779144,
        -0.0050504133105278015,
        0.04299033433198929,
        0.023169126361608505,
        -0.011185095645487309,
        -0.019669027999043465,
        -0.029142120853066444,
        -0.05524067580699921,
        0.03834889829158783,
        -0.043446868658065796,
        0.018565736711025238,
        0.062050651758909225,
        -0.039261966943740845,
        0.04120223969221115,
        -0.01105193980038166,
        0.005882637575268745,
        0.03005518950521946,
        -0.032490041106939316,
        0.028152961283922195,
        0.004144477192312479,
        -0.019650006666779518,
        -0.030663901939988136,
        0.0134487459436059,
        0.02476699836552143,
        -0.017196133732795715,
        -0.01098536141216755,
        -0.01055736094713211,
        0.009059356525540352,
        -0.005487925373017788,
        -0.00846491102129221,
        -0.027201848104596138,
        0.04980030655860901,
        -0.00018977688159793615,
        0.03384062275290489,
        -0.013895769603550434,
        -0.03813965618610382,
        -0.023302283138036728,
        0.0547841414809227,
        -0.01600724086165428,
        0.03138674795627594,
        -0.05512654408812523,
        -0.010795138776302338,
        -0.011403852142393589,
        -0.011907941661775112,
        -0.058702729642391205,
        0.008098731748759747,
        0.007884731516242027,
        0.029788877815008163,
        0.00961100310087204,
        0.02906603179872036,
        -0.025527888908982277,
        -0.029769854620099068,
        0.0007353296969085932,
        0.03370746597647667,
        0.045273005962371826,
        0.033783555030822754,
        0.020068496465682983,
        -0.0325661301612854,
        -0.02714478224515915,
        0.011993542313575745,
        -0.026821402832865715,
        0.040593527257442474,
        0.04222944378852844,
        -0.018099691718816757,
        -0.030759012326598167,
        0.042457710951566696,
        -0.02733500488102436,
        -0.03734071925282478,
        -0.03488684445619583,
        -0.039946772158145905,
        -0.013600924052298069,
        0.005350013729184866,
        -0.028856785967946053,
        -0.01399088092148304,
        -0.042115308344364166,
        0.005178813356906176,
        -0.008935712277889252,
        -0.011337273754179478,
        0.015778973698616028,
        -0.004375122487545013,
        -0.001496815006248653,
        0.009591980837285519,
        -0.03277537226676941,
        0.05193080008029938,
        0.03756898641586304,
        -0.020905476063489914,
        0.035362403839826584,
        0.0011716530425474048,
        -0.01695835590362549,
        -0.012811499647796154,
        -0.008455399423837662,
        0.030606834217905998,
        -0.019973386079072952,
        -0.010614427737891674,
        0.01569337397813797,
        0.013391679152846336,
        -0.009767936542630196,
        -0.006244060583412647,
        0.01828991435468197,
        0.011888919398188591,
        -0.0028866296634078026,
        -0.035362403839826584,
        0.03005518950521946,
        0.042115308344364166,
        0.0009594358270987868,
        -0.0019913939759135246,
        -0.03709343075752258,
        0.01749097928404808,
        0.011337273754179478,
        -0.02792469412088394,
        0.04610998556017876,
        0.02413926273584366,
        0.030759012326598167,
        -0.0010135304182767868,
        -0.0582461953163147,
        0.06684426218271255,
        -0.044245801866054535,
        -0.03642765060067177,
        -0.010519316419959068,
        0.027753494679927826,
        -0.009244823828339577,
        -0.024862108752131462,
        -0.011755763553082943,
        -0.03857716545462608,
        0.023473482578992844,
        -0.007732553407549858,
        0.054898276925086975,
        -0.021989746019244194,
        0.06536052376031876,
        0.01890813745558262,
        -0.024443618953227997,
        0.01068100519478321,
        -0.03094923496246338,
        0.021438099443912506,
        -0.04333273321390152,
        0.010909272357821465,
        0.0231881495565176,
        0.04820243641734123,
        0.03859619051218033,
        -0.056534189730882645,
        0.01615941897034645,
        0.006334416568279266,
        0.025337666273117065,
        -0.04040330648422241,
        0.002453872933983803,
        0.0076564643532037735,
        -0.023625660687685013,
        0.02940843254327774,
        0.03593306988477707,
        0.08910032361745834,
        -0.01989729516208172,
        0.014561548829078674,
        0.020201653242111206,
        -0.02729696035385132,
        0.022141924127936363,
        -0.034772712737321854,
        0.042914245277643204,
        -0.013096833601593971,
        0.029731810092926025,
        0.07677388936281204,
        0.0003816343378275633,
        0.040593527257442474,
        0.03774018585681915,
        0.040745705366134644,
        -0.016701554879546165,
        0.0028081629425287247,
        -0.01692982204258442,
        0.012992211617529392,
        0.0171485785394907,
        -0.004149232991039753,
        0.01109949592500925,
        -0.012316920794546604,
        0.0221989918500185,
        -0.03167208284139633,
        -0.00012096975842723623,
        0.041278328746557236,
        -0.027411093935370445,
        0.003916210029274225,
        -0.028286118060350418,
        -0.010300559923052788,
        -0.039946772158145905,
        -0.05497436597943306,
        -0.02571811154484749,
        -0.02547082118690014,
        -0.027658382430672646,
        0.011888919398188591,
        -0.010272026993334293,
        0.030359545722603798,
        0.004513034131377935,
        0.013876747339963913,
        0.013220478780567646,
        0.005373791791498661,
        -0.03568578138947487,
        -0.02235116995871067,
        0.009244823828339577,
        0.05227320268750191,
        0.007613664027303457,
        0.006158460397273302,
        -0.030321501195430756,
        -0.04515887424349785,
        0.0028010294772684574,
        0.0009255523909814656,
        0.002594162244349718,
        -0.0005605625919997692,
        -0.029008964076638222,
        -0.0034358978737145662,
        -0.014247681014239788,
        -0.02062014304101467,
        -0.04938181862235069,
        -0.024805042892694473,
        0.017624134197831154,
        0.05451783165335655,
        -0.017348311841487885,
        -0.0572570376098156,
        0.024500686675310135,
        0.02497624233365059,
        0.014038436114788055,
        -0.01897471584379673,
        0.005939704366028309,
        -0.003100630361586809,
        -0.009011801332235336,
        0.030511723831295967,
    ]
    # Example filter for testing - common filter used by multiple tests
    filter_example = {
        "and": [
            {"id": "45a4f936-2182-44c6-8c4f-4a9476941e51"},
            {
                "A": "中国广西"
            },
            {
                "B": "狗肉"
            },
            {"created_at":{"gt":"2025-09-19"}},
            {"created_at": {"lt": "2025-11-26"}},
            # {"tags": {"=": "mode:fast"}}
        ]
    }

    # Example filters for get_by_metadata
    filters_example = [
        {"field": "tags", "op": "contains", "value": "mode:fast"},
    ]

    # Create connection once - shared by all tests
    graph = getPolarDb()
    user_name = "adimin"
    scope = "WorkingMemory"
    knowledgebase_ids = ["memosfeebbc2bd1744d7bb5b5ec57f38e828d","adimin2"]

    # Run all tests - uncomment the test you want to run
    test_search_by_embedding(graph, vector, user_name, filter_example,knowledgebase_ids)
    # test_get_all_memory_items(graph, "WorkingMemory", False, user_name, filter_example,knowledgebase_ids)
    # test_get_by_metadata(graph, filters_example, user_name, filter_example,knowledgebase_ids)

    # Or run all tests

    # Test search_by_embedding
    # test_search_by_embedding(graph, vector, user_name, filter_example)

    # Test get_node - query single node
    # test_get_node(graph, '"65c3a65b-78f7-4009-bc92-7ee1981deb3a"', '"adimin"')

    # Test get_nodes - query multiple nodes
    # test_get_nodes(graph, ["65c3a65b-78f7-4009-bc92-7ee1981deb3a", "65c3a65b-78f7-4009-bc92-7ee1981deb3b"], user_name)

    # Test update_node
    # test_update_node(graph, "000009999ef-926f-42e2-b7b5-0224daf0abcd", {"name": "new_name"}, user_name)
    # test_update_node(graph, "bb079c5b-1937-4125-a9e5-55d4abe6c95d", {"status": "inactived", "tags": ["yoga", "travel11111111", "local studios5667888"]}, user_name)

    # Test get_memory_count
    # test_get_memory_count(graph, 'UserMemory', user_name)

    # Test node_not_exist
    # test_node_not_exist(graph, 'UserMemory', user_name)

    # Test remove_oldest_memory
    # test_remove_oldest_memory(graph, 'UserMemory', 2, user_name)

    # Test delete_node
    # test_delete_node(graph, "bb079c5b-1937-4125-a9e5-55d4abe6c95d", user_name)

    # Test get_all_memory_items
    # test_get_all_memory_items(graph, scope, False, user_name, filter_example)

    # Test get_by_metadata
    # test_get_by_metadata(graph, filters_example, user_name, filter_example)

    # searchVector(db_name="test_1020_02", vectorStr=vector)

    # add_edge(db_name="memtensor_memos",source_id="13bb9df6-0609-4442-8bed-bba77dadac92", target_id="2dd03a5b-5d5f-49c9-9e0a-9a2a2899b98d", edge_type="PARENT", user_name="memosbfb3fb32032b4077a641404dc48739cd")
    # edge_exists(db_name="memtensor_memos", source_id="13bb9df6-0609-4442-8bed-bba77dadac92",
    #             target_id="2dd03a5b-5d5f-49c9-9e0a-9a2a2899b98d", type="PARENT", direction="OUTGOING",
    #             user_name="memosbfb3fb32032b4077a641404dc48739cd")

    # get_children_with_embeddings(db_name="memtensor_memos", id="13bb9df6-0609-4442-8bed-bba77dadac92",user_name="memos07ea708ac7eb412887c5c283f874ea30")

    # get_subgraph(db_name="memtensor_memos", center_id="503ab3d5-919d-4986-b0f4-15b65c049686", depth=1,
    #              center_status="activated", user_name="memos07ea708ac7eb412887c5c283f874ea30")

    #
    # get_grouped_counts(db_name="memtensor_memos", user_name="memos07ea708ac7eb412887c5c283f874ea30")

    # export_graph(db_name="memtensor_memos", include_embedding=False, user_name="memosa4d810417e8e4272a1c08df420be9e60")

    # get_structure_optimization_candidates(db_name="memtensor_memos", scope='UserMemory', include_embedding=False, user_name="memos8f5530534d9b413bb8981ffc3d48a495")

    # get_all_memory_items(db_name="memtensor_memos", scope='UserMemory', include_embedding=False, user_name="memosfeebbc2bd1744d7bb5b5ec57f38e828d")
    # get_all_memory_items(db_name="memos_test", scope='LongTermMemory', include_embedding=False, user_name="adimin",filter=filter)

    # 测试 get_structure_optimization_candidates 函数
    # get_structure_optimization_candidates(db_name="memtensor_memos", scope='UserMemory', include_embedding=False, user_name="memos8f5530534d9b413bb8981ffc3d48a495")

    # get_neighbors_by_tag(db_name="memtensor_memos",user_name="memosfeebbc2bd1744d7bb5b5ec57f38e828d")

    # get_edges(db_name="memtensor_memos", id="13bb9df6-0609-4442-8bed-bba77dadac92",type="PARENT",direction="OUTGOING",user_name="memosfeebbc2bd1744d7bb5b5ec57f38e828d")

    # get_by_metadata(db_name="memtensor_memos", filters=[{"field": "tags", "op": "contains", "value": "glazes"}], user_name="memos452356faadb34b06acc7fa507023d91c")
    # get_by_metadata(
    #     db_name="memos_test",
    #     filters=[{"field": "tags", "op": "contains", "value": "Python"}],
    #     user_name="adimin",
    #     filter=filter,
    # )
